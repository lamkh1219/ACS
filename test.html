<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿæ´»å‹•æ—¥ç¨‹æŸ¥è©¢ç³»çµ±</title>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 15px; /* æ‰‹æ©Ÿç‰ˆç¸®å°é‚Šè· */
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.5rem;
        }

        /* --- æ§åˆ¶é¢æ¿æ¨£å¼ --- */
        .control-panel {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .input-group label {
            font-weight: bold;
            margin-right: 10px;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ›è¡Œ */
        }

        .input-group input {
            flex-grow: 1;
            padding: 8px;
            font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
            border: 1px solid #ced4da;
            border-radius: 4px;
            min-width: 0; /* é˜²æ­¢ flex å­å…ƒç´ æº¢å‡º */
        }

        /* --- æœå°‹å€å¡Šæ¨£å¼ --- */
        .search-container {
            margin-top: 5px;
            padding: 15px;
            background-color: #d1ecf1;
            border-radius: 5px;
            border: 1px solid #bee5eb;
        }

        .search-header {
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 10px;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
        }

        .search-controls select, 
        .search-controls input {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #17a2b8;
            font-size: 16px;
            height: 42px; /* çµ±ä¸€é«˜åº¦ */
            box-sizing: border-box;
        }

        .search-controls select {
            background-color: white;
            flex: 1 1 100%; /* æ‰‹æ©Ÿç‰ˆé è¨­æ»¿å¯¬ */
        }
        
        .search-controls input {
            flex: 1 1 100%;
        }

        .input-hidden {
            display: none !important;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            white-space: nowrap;
        }
        .status-ok { background-color: #d4edda; color: #155724; }
        .status-wait { background-color: #fff3cd; color: #856404; }
        
        .hint {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 2px;
        }

        /* --- çµæœå¡ç‰‡æ¨£å¼ --- */
        .activity-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden; /* ç¢ºä¿åœ“è§’ */
        }

        .activity-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
        }

        .activity-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .activity-meta {
            font-size: 0.9rem;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            opacity: 0.95;
        }
        .meta-item {
            background-color: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* --- è¡¨æ ¼æ¨£å¼ (é è¨­æ¡Œé¢ç‰ˆ) --- */
        .student-table {
            width: 100%;
            border-collapse: collapse;
        }
        .student-table th, .student-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .student-table th {
            background-color: #f1f3f5;
            color: #495057;
            font-weight: 600;
        }
        
        .lunch-tag {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.8em;
            border-radius: 4px;
            background-color: #28a745;
            color: white;
        }
        .no-lunch { color: #adb5bd; font-size: 0.9em;}
        .highlight { background-color: #fff3cd !important; }

        .error-msg {
            color: #dc3545;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
        }

        /* =========================================
           ğŸ“± æ‰‹æ©Ÿç‰ˆå°ˆç”¨æ¨£å¼ (Responsive CSS)
           ========================================= */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            
            /* è¼¸å…¥å€å¡Šè®Šå‚ç›´æ’åˆ— */
            .input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .input-group label {
                margin-bottom: 5px;
                font-size: 0.95rem;
            }
            .input-group input, .input-group select {
                width: 100%;
                box-sizing: border-box; /* é‡è¦ï¼šåŒ…å« padding */
            }

            /* æœå°‹æ§åˆ¶é … */
            .search-controls { flex-direction: column; }
            
            /* ----- è¡¨æ ¼è½‰ç‚ºæ¸…å–®æ¨¡å¼ (æ ¸å¿ƒå„ªåŒ–) ----- */
            .student-table, .student-table tbody, .student-table tr, .student-table td {
                display: block;
                width: 100%;
            }
            
            /* éš±è—è¡¨é ­ */
            .student-table thead { display: none; }

            .student-table tr {
                margin-bottom: 0;
                border-bottom: 1px solid #eee;
                padding: 10px 15px;
                position: relative;
            }
            
            /* å°‡å„²å­˜æ ¼å…§å®¹é‡çµ„ */
            .student-table td {
                padding: 2px 0;
                border: none;
                text-align: left;
            }

            /* ç¬¬ä¸€è¡Œï¼šç­åˆ¥ + å­¸è™Ÿ + å§“å */
            /* æˆ‘å€‘åœ¨ JS ä¸­æœƒçµ¦ td åŠ  class ä¾†æ§åˆ¶æ¨£å¼ï¼Œæˆ–è€…ç”¨ nth-child */
            
            /* ç­åˆ¥èˆ‡å­¸è™Ÿé¡¯ç¤ºåœ¨åŒä¸€è¡Œï¼Œè®Šå°ä¸€é» */
            .student-table td:nth-child(1) { /* Class */
                display: inline-block;
                font-weight: bold;
                color: #007bff;
                width: auto;
                margin-right: 5px;
            }
            .student-table td:nth-child(1)::after { content: "ç­"; font-size: 0.8em; font-weight: normal; color: #666; }

            .student-table td:nth-child(2) { /* No */
                display: inline-block;
                width: auto;
                color: #666;
                font-size: 0.9em;
                margin-right: 10px;
            }
            .student-table td:nth-child(2)::before { content: "("; }
            .student-table td:nth-child(2)::after { content: ")"; }

            .student-table td:nth-child(3) { /* Name */
                display: inline-block;
                font-size: 1.1rem;
                font-weight: bold;
                color: #333;
            }

            .student-table td:nth-child(4) { /* Remark/Lunch */
                margin-top: 4px;
                padding-top: 4px;
                border-top: 1px dashed #eee;
                font-size: 0.9em;
                color: #555;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“… å­¸ç”Ÿæ´»å‹•æ—¥ç¨‹æŸ¥è©¢</h1>
    
    <div class="control-panel">
        <div class="input-group">
            <label>1. æ´»å‹•æ—¥ç¨‹ (other_data.csv)</label>
            <span id="scheduleStatus" class="status-badge status-wait">è®€å–ä¸­...</span>
        </div>

        <div class="input-group">
            <label for="studentFile">2. ä¸Šå‚³å­¸ç”Ÿåå–® (data.csv)</label>
            <input type="file" id="studentFile" accept=".csv">
            <span id="studentStatus" class="status-badge status-wait" style="margin-top:5px;">ç­‰å¾…ä¸Šå‚³</span>
        </div>
        <div class="hint">è«‹ä¸Šå‚³åŒ…å« Name, Class, ClassNo, Activity æ¬„ä½çš„ CSVã€‚</div>

        <div class="input-group" style="border-left: 4px solid #007bff;">
            <label for="datePicker">3. é¸æ“‡æŸ¥è©¢æ—¥æœŸ</label>
            <input type="date" id="datePicker" disabled>
        </div>

        <div class="search-container">
            <div class="search-header">
                ğŸ” æœå°‹èˆ‡ç¯©é¸
            </div>
            <div class="search-controls">
                <select id="searchMode" disabled>
                    <option value="activity">æ¨¡å¼ 1: ä¾æ´»å‹•ç¯©é¸</option>
                    <option value="name">æ¨¡å¼ 2: åƒ…æœå°‹å§“å</option>
                    <option value="class">æ¨¡å¼ 3: åƒ…æœå°‹ç­åˆ¥</option>
                    <option value="batch">æ¨¡å¼ 4: æ‰¹é‡æœå°‹ (e.g. 1A5, 5D18)</option>
                </select>

                <select id="activityList" class="input-hidden">
                    <option value="">-- è«‹å…ˆé¸æ“‡æ—¥æœŸ --</option>
                </select>

                <input type="text" id="inputMain" placeholder="è¼¸å…¥å§“å..." class="input-hidden">
            </div>
        </div>
    </div>

    <div id="error" class="error-msg" style="display:none;"></div>
    <div id="results"></div>
</div>

<script>
    let studentsData = [];
    let scheduleData = [];
    let isScheduleLoaded = false;
    let isStudentLoaded = false;

    // CSV è§£æå‡½æ•¸
    function parseCSV(text) {
        const lines = text.split('\n').filter(line => line.trim() !== '');
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '')); 
        
        return lines.slice(1).map(line => {
            const values = [];
            let match;
            const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;
            let currentLine = line;
            while (match = regex.exec(currentLine)) {
                let val = match[1].replace(/^"|"$/g, '').trim();
                values.push(val);
            }
            const simpleValues = line.split(',');
            const finalValues = values.length === headers.length ? values : simpleValues;

            const entry = {};
            headers.forEach((h, i) => {
                entry[h] = finalValues[i] ? finalValues[i].trim() : '';
            });
            return entry;
        });
    }

    function convertDDMMYYYYToISO(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.trim().split('/');
        if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
        return null;
    }

    function isActivityOnDate(activityDateStr, selectedISODate) {
        if (!activityDateStr) return false;
        const dates = activityDateStr.split(',');
        for (let d of dates) {
            const iso = convertDDMMYYYYToISO(d.trim());
            if (iso === selectedISODate) return true;
        }
        return false;
    }

    function checkReady() {
        const datePicker = document.getElementById('datePicker');
        const searchMode = document.getElementById('searchMode');
        
        if (isScheduleLoaded && isStudentLoaded) {
            datePicker.disabled = false;
            datePicker.placeholder = "è«‹é¸æ“‡æ—¥æœŸ";
            searchMode.disabled = false;
            updateUIByMode(); 
        } else {
            datePicker.disabled = true;
            searchMode.disabled = true;
        }
    }

    function updateUIByMode() {
        const mode = document.getElementById('searchMode').value;
        const activityList = document.getElementById('activityList');
        const inputMain = document.getElementById('inputMain');
        
        activityList.classList.add('input-hidden');
        inputMain.classList.add('input-hidden');
        inputMain.value = '';

        if (mode === 'activity') {
            activityList.classList.remove('input-hidden');
        } 
        else if (mode === 'name') {
            inputMain.classList.remove('input-hidden');
            inputMain.placeholder = 'è¼¸å…¥å§“å...';
        } 
        else if (mode === 'class') {
            inputMain.classList.remove('input-hidden');
            inputMain.placeholder = 'è¼¸å…¥ç­åˆ¥ (ä¾‹å¦‚ 4A)...';
        } 
        else if (mode === 'batch') {
            inputMain.classList.remove('input-hidden');
            inputMain.placeholder = 'è¼¸å…¥ä»£ç¢¼ (1A5, 5D18)';
        }
    }

    function updateActivityDropdown(selectedISODate) {
        const activitySelect = document.getElementById('activityList');
        activitySelect.innerHTML = '<option value="">-- é¡¯ç¤ºæ‰€æœ‰æ´»å‹• --</option>';

        if (!selectedISODate) return;

        const todaysActivities = scheduleData.filter(item => {
            return isActivityOnDate(item.Date, selectedISODate);
        });

        const uniqueActivities = [...new Set(todaysActivities.map(item => item.Activity))];

        uniqueActivities.forEach(actName => {
            const option = document.createElement('option');
            option.value = actName;
            option.textContent = actName;
            activitySelect.appendChild(option);
        });
    }

    async function loadScheduleFromServer() {
        const statusSpan = document.getElementById('scheduleStatus');
        const errorDiv = document.getElementById('error');
        try {
            const response = await fetch('other_data.csv');
            if (!response.ok) throw new Error('ç„¡æ³•è®€å–æª”æ¡ˆ (404)');
            const text = await response.text();
            scheduleData = parseCSV(text);
            isScheduleLoaded = true;
            statusSpan.textContent = `âœ… è¼‰å…¥æˆåŠŸ (${scheduleData.length} ç­†)`;
            statusSpan.className = 'status-badge status-ok';
            checkReady();
        } catch (err) {
            console.error(err);
            statusSpan.textContent = 'è¼‰å…¥å¤±æ•—';
            statusSpan.style.backgroundColor = '#f8d7da';
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° other_data.csvï¼Œè«‹ç¢ºèªæª”æ¡ˆä½ç½®ã€‚';
        }
    }

    document.getElementById('studentFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const statusSpan = document.getElementById('studentStatus');
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                studentsData = parseCSV(e.target.result);
                isStudentLoaded = true;
                statusSpan.textContent = `âœ… è¼‰å…¥æˆåŠŸ (${studentsData.length} äºº)`;
                statusSpan.className = 'status-badge status-ok';
                checkReady();
                refreshDisplay();
            } catch (err) { alert("CSV è§£æå¤±æ•—"); }
        };
        reader.readAsText(file);
    });

    document.getElementById('searchMode').addEventListener('change', function() {
        updateUIByMode();
        refreshDisplay();
    });

    document.getElementById('datePicker').addEventListener('change', function(e) {
        const dateVal = e.target.value;
        updateActivityDropdown(dateVal);
        refreshDisplay();
    });

    document.getElementById('activityList').addEventListener('change', refreshDisplay);
    document.getElementById('inputMain').addEventListener('input', refreshDisplay);

    function refreshDisplay() {
        const dateVal = document.getElementById('datePicker').value;
        if (dateVal) displayResults(dateVal);
    }

    function displayResults(selectedISODate) {
        const container = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        container.innerHTML = '';
        errorDiv.style.display = 'none';
        
        if (!selectedISODate || !isScheduleLoaded || !isStudentLoaded) return;

        const mode = document.getElementById('searchMode').value;
        const activityFilterVal = document.getElementById('activityList').value; 
        const valMain = document.getElementById('inputMain').value.trim();

        let todaysActivities = scheduleData.filter(item => {
            return isActivityOnDate(item.Date, selectedISODate);
        });

        if (todaysActivities.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:30px; color:#666;">
                <h3>ğŸ“… ${selectedISODate}</h3>
                <p>ç•¶å¤©æ²’æœ‰å®‰æ’ä»»ä½•æ´»å‹•ã€‚</p>
            </div>`;
            return;
        }

        if (mode === 'activity' && activityFilterVal !== '') {
            todaysActivities = todaysActivities.filter(item => item.Activity === activityFilterVal);
        }

        // Batch parsing
        let batchTargets = [];
        if (mode === 'batch' && valMain.length > 0) {
            const tokens = valMain.toUpperCase().split(/[\s,]+/).filter(t => t.length > 0);
            const regex = /^(\d+[A-Z])(\d+)$/;
            tokens.forEach(token => {
                const match = token.match(regex);
                if (match) {
                    batchTargets.push({ cls: match[1], no: parseInt(match[2]) });
                }
            });
        }

        let hasResult = false;

        todaysActivities.forEach(activity => {
            const activityName = activity.Activity;
            let participants = studentsData.filter(s => s.Activity === activityName);

            if (mode !== 'activity') {
                participants = participants.filter(s => {
                    const sName = (s.Name || '').toLowerCase();
                    const sClass = (s.Class || '').toUpperCase().trim();
                    const sNo = parseInt(s.ClassNo || '0');
                    const inputLower = valMain.toLowerCase();

                    if (mode === 'name') return sName.includes(inputLower);
                    if (mode === 'class') return valMain === '' || sClass === inputLower.toUpperCase();
                    if (mode === 'batch') {
                        if (batchTargets.length === 0) return true;
                        return batchTargets.some(target => target.cls === sClass && target.no === sNo);
                    }
                    return true;
                });

                const hasInput = valMain.length > 0;
                if (hasInput && participants.length === 0) return;
            }

            hasResult = true;

            const card = document.createElement('div');
            card.className = 'activity-card';

            const header = document.createElement('div');
            header.className = 'activity-header';
            header.innerHTML = `
                <div class="activity-title">${activityName}</div>
                <div class="activity-meta">
                    <span class="meta-item">ğŸ•’ ${activity.Time || '--'}</span>
                    <span class="meta-item">ğŸ“ ${activity.Location || '--'}</span>
                    <span class="meta-item">ğŸ‘¤ ${activity.TIC || '--'}</span>
                </div>
            `;
            card.appendChild(header);

            if (participants.length > 0) {
                const table = document.createElement('table');
                table.className = 'student-table';
                
                // HTML çµæ§‹èˆ‡ä¹‹å‰ç›¸åŒï¼Œä½† CSS åšäº†æ‰‹æ©Ÿç‰ˆå„ªåŒ–
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th width="15%">ç­åˆ¥</th>
                            <th width="15%">å­¸è™Ÿ</th>
                            <th width="30%">å§“å</th>
                            <th width="40%">å‚™è¨» / é€±äº”åˆè†³</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${participants.map(s => {
                            const stayLunch = s['Stay Lunch'] && s['Stay Lunch'].trim().length > 0;
                            const lunchBadge = stayLunch 
                                ? `<span class="lunch-tag">ç•™æ ¡: ${s['Stay Lunch']}</span>` 
                                : '<span class="no-lunch">-</span>';
                            
                            let rowClass = (mode !== 'activity' && valMain.length > 0) ? 'highlight' : '';

                            return `
                                <tr class="${rowClass}">
                                    <td>${s.Class}</td>
                                    <td>${s.ClassNo || '-'}</td>
                                    <td>${s.Name}</td>
                                    <td>${lunchBadge}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                `;
                card.appendChild(table);
            } else {
                const noData = document.createElement('div');
                noData.style.padding = '20px';
                noData.style.textAlign = 'center';
                noData.style.color = '#777';
                noData.textContent = `ç„¡ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿè³‡æ–™`;
                card.appendChild(noData);
            }

            container.appendChild(card);
        });

        if (!hasResult) {
            container.innerHTML = `<div style="text-align:center; padding:20px; color:#dc3545;">
                <h3>ğŸ” æŸ¥ç„¡è³‡æ–™</h3>
                <p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ´»å‹•æˆ–å­¸ç”Ÿã€‚</p>
            </div>`;
        }
    }

    loadScheduleFromServer();

</script>

</body>
</html>
