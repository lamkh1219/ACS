<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QR Code åœ–ç‰‡æƒæå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* ==================================== */
        /* 1. é é¢èˆ‡ä½ˆå±€æ¨£å¼ */
        /* ==================================== */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
        }

        #main-container {
            max-width: 600px; 
            width: 100%;
            background: #ffffff;
            padding: 30px;
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); 
            text-align: center;
            /* æ‹–æ”¾åŠŸèƒ½ç›¸é—œæ¨£å¼ */
            border: 2px dashed transparent; 
            transition: border-color 0.3s;
        }

        /* æ‹–æ›³åœ–ç‰‡é€²å…¥å€åŸŸæ™‚çš„è¦–è¦ºåé¥‹ */
        .drag-over {
            border-color: #007bff !important; 
            background-color: #eaf3ff; 
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        /* ==================================== */
        /* 2. æª”æ¡ˆé¸æ“‡æŒ‰éˆ•æ¨£å¼ */
        /* ==================================== */
        #qr-input-file {
             display: none;
        }
        
        #custom-upload-button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #custom-upload-button:hover {
            background-color: #0056b3;
        }

        #custom-upload-button:active {
            transform: scale(0.98);
        }

        /* ==================================== */
        /* 3. æƒæå™¨/åœ–ç‰‡é è¦½å€æ¨£å¼ */
        /* ==================================== */
        #reader { 
            width: 100%;
            max-width: 400px; 
            margin: 20px auto; 
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #reader > div {
            width: 100% !important;
            height: auto !important;
        }

        /* ==================================== */
        /* 4. çµæœé¡¯ç¤ºå€æ¨£å¼ (ç‹€æ…‹è¦–è¦ºåŒ–) */
        /* ==================================== */
        #result-display { 
            margin-top: 25px; 
            padding: 20px; 
            border: 2px solid #ccc; 
            border-radius: 8px; 
            min-height: 50px; 
            text-align: left;
            word-wrap: break-word;
            transition: all 0.3s;
        }

        .scanning {
            border-color: #ffc107 !important; 
            background-color: #fff3cd; 
            color: #856404;
        }

        .success { 
            border-color: #28a745 !important; 
            background-color: #d4edda; 
            color: #155724;
        }

        .error { 
            border-color: #dc3545 !important; 
            background-color: #f8d7da; 
            color: #721c24;
        }

        #result-display p {
            margin: 5px 0;
        }
        
        #result-display p:first-child {
            font-weight: bold;
        }
        
        #result-display a {
            color: #007bff;
            word-break: break-all;
        }
    </style>
</head>
<body>

    <div id="main-container">
        <h1>ğŸ“¸ æ‹–æ”¾æˆ–é»æ“Šæƒæ QR Code åœ–ç‰‡</h1>
        
        <p style="color:#666;">å°‡åœ–ç‰‡æ‹–æ›³åˆ°æ­¤å€åŸŸï¼Œæˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•</p>

        <button id="custom-upload-button">é¸æ“‡ QR Code åœ–ç‰‡é€²è¡Œæƒæ</button>
        
        <input type="file" id="qr-input-file" accept="image/*">

        <div id="reader"></div>

        <div id="result-display">
            <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•æˆ–æ‹–æ›³åœ–ç‰‡ä¾†é–‹å§‹æƒæã€‚</p>
        </div>
    </div>

    <script>
        // å–å¾— HTML å…ƒç´ 
        const mainContainer = document.getElementById('main-container'); 
        const fileInput = document.getElementById('qr-input-file');
        const customButton = document.getElementById('custom-upload-button');
        const resultDisplay = document.getElementById('result-display');
        
        // åˆå§‹åŒ– Html5Qrcode å¯¦ä¾‹
        const html5QrCode = new Html5Qrcode("reader");

        /**
         * åŸ·è¡Œæƒæçš„é€šç”¨å‡½æ•¸
         * @param {File} imageFile è¦æƒæçš„ File ç‰©ä»¶
         */
        function scanImageFile(imageFile) {
            // æ¸…é™¤ä¹‹å‰çš„çµæœä¸¦è¨­ç½®ã€Œæ­£åœ¨æƒæã€ç‹€æ…‹
            resultDisplay.innerHTML = '<p>â³ æ­£åœ¨æƒæåœ–ç‰‡...</p>';
            resultDisplay.className = 'scanning';
            
            html5QrCode.scanFile(imageFile, /* showImage */ true) 
                .then(decodedText => {
                    // æˆåŠŸ
                    console.log("æˆåŠŸè§£ç¢¼çš„æ–‡å­—:", decodedText);
                    
                    let resultContent = '';
                    // æª¢æŸ¥æƒæçµæœæ˜¯å¦ç‚ºé€£çµ
                    if (decodedText.startsWith('http')) {
                        // è¨­å®šè¶…é€£çµï¼šä½¿ç”¨ target="_blank" åœ¨æ–°åˆ†é é–‹å•Ÿ
                        resultContent = `<p>æƒæçµæœç‚ºé€£çµ (é»æ“Šé–‹å•Ÿæ–°åˆ†é )ï¼š</p><a href="${decodedText}" target="_blank" rel="noopener noreferrer">${decodedText}</a>`;
                    } else {
                        // å¦å‰‡ï¼Œé¡¯ç¤ºç´”æ–‡å­—çµæœ
                        resultContent = `<p>æƒæçµæœï¼š</p><p>${decodedText}</p>`;
                    }

                    resultDisplay.innerHTML = `<p class="success">âœ… æƒææˆåŠŸï¼</p>${resultContent}`;
                    resultDisplay.className = 'success';
                })
                .catch(err => {
                    // å¤±æ•—
                    console.error("æƒæå¤±æ•—åŸå› :", err); 
                    resultDisplay.innerHTML = `<p class="error">âŒ æƒæå¤±æ•—ï¼</p><p>ç„¡æ³•åµæ¸¬åˆ° QR Code æˆ–æ¢ç¢¼ã€‚(${err})</p>`;
                    resultDisplay.className = 'error';
                });
        }
        
        // 1. é»æ“ŠæŒ‰éˆ•åŠŸèƒ½
        customButton.addEventListener('click', () => {
            fileInput.click();
        });

        // 2. æª”æ¡ˆé¸æ“‡äº‹ä»¶
        fileInput.addEventListener('change', e => {
            if (e.target.files.length === 0) {
                resultDisplay.innerHTML = '<p class="error">âŒ å·²å–æ¶ˆé¸æ“‡æª”æ¡ˆã€‚</p>';
                resultDisplay.className = 'error';
                return;
            }

            const imageFile = e.target.files[0];
            scanImageFile(imageFile);
        });

        // 3. æ‹–æ”¾ (Drag and Drop) äº‹ä»¶è™•ç†

        // é˜»æ­¢é è¨­è¡Œç‚º
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            mainContainer.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        // æ‹–æ›³é€²å…¥æ™‚æ·»åŠ è¦–è¦ºæ•ˆæœ
        ['dragenter', 'dragover'].forEach(eventName => {
            mainContainer.addEventListener(eventName, () => {
                mainContainer.classList.add('drag-over');
            }, false);
        });

        // æ‹–æ›³é›¢é–‹æˆ–æ”¾ä¸‹æ™‚ç§»é™¤è¦–è¦ºæ•ˆæœ
        ['dragleave', 'drop'].forEach(eventName => {
            mainContainer.addEventListener(eventName, () => {
                mainContainer.classList.remove('drag-over');
            }, false);
        });

        // è™•ç†æª”æ¡ˆæ”¾ä¸‹äº‹ä»¶
        mainContainer.addEventListener('drop', e => {
            const dt = e.dataTransfer;
            const files = dt.files;

            // æª¢æŸ¥æ˜¯å¦æœ‰æ‹–æ›³æª”æ¡ˆ
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const imageFile = files[0];
                scanImageFile(imageFile); // æƒææ‹–æ”¾é€²ä¾†çš„ç¬¬ä¸€å€‹æª”æ¡ˆ
            } else {
                resultDisplay.innerHTML = '<p class="error">âŒ æ‹–æ”¾å¤±æ•—ï¼</p><p>è«‹æ‹–æ›³æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆã€‚</p>';
                resultDisplay.className = 'error';
            }
        }, false);

    </script>

</body>
</html>
